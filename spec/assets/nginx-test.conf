pid               <%= pid_file %>;
error_log         <%= error_log %> error;

worker_processes      <%= worker_processes %>;
worker_rlimit_core    500M;
working_directory     <%= File.join(nginx_tests_tmp_dir, "cores", config_id) %>;

events {
  worker_connections  4096;
  use                 <%= (RUBY_PLATFORM =~ /darwin/) ? 'kqueue' : 'epoll' %>;
}

http {
  default_type    application/octet-stream;

  log_format main '$remote_addr - [$time_local] $host $request ($status) $request_time s '
                  '$body_bytes_sent b $http_referer $http_x_forwarded_for - '
                  '[$upstream_cache_status] $upstream_response_time s - $http_user_agent ';

  access_log      <%= access_log %> main;

  <%= additional_config %>
  proxy_cache_path <%= proxy_cache_path %> levels=1:2 keys_zone=zone:10m inactive=10d max_size=100m loader_files=100 loader_sleep=1;

  error_page   404 /error_pages/404.html;

  server {
    listen        <%= nginx_port %>;
    server_name   <%= nginx_host %>;

    selective_cache_purge_database "<%= database_file %>";

    location ~ /purge(.*) {
      selective_cache_purge_query <%= purge_query %>;
    }

    location /error_pages {
      internal;
      return 404 $uri;
    }

    location /no-cache {
      proxy_pass http://unix:/tmp/nginx_test.socket;
    }

    location /unavailable {
      proxy_pass http://unix:/tmp/nginx_test_unavailable.socket;

      proxy_cache zone;
      proxy_cache_key "$uri";
      proxy_cache_valid 200 1m;
      proxy_cache_valid any 30s;
      proxy_cache_use_stale timeout updating;
    }

    location / {
      proxy_pass http://unix:/tmp/nginx_test.socket;

      proxy_cache zone;
      proxy_cache_key "$uri";
      proxy_cache_valid 200 1m;
      proxy_cache_valid any 30s;
      proxy_cache_use_stale timeout updating;
    }
  }

  server {
    listen unix:/tmp/nginx_test.socket;

    location /not-found {
      return 404;
    }

    location / {
      return 200;
    }
  }
}
